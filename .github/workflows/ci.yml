name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  setup:
    name: Setup and Install Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify installation
        run: |
          pip list
          python --version
          echo "Verifying all required packages are installed..."
          pip check

      - name: Validate package imports
        run: |
          python -c "
          import sys

          # List of core packages to validate
          packages = [
              'numpy',
              'pandas',
              'pyarrow',
              'scipy',
              'sklearn',
              'torch',
              'tensorboard',
              'matplotlib',
              'PIL',
              'requests',
              'pydantic'
          ]

          print('Testing package imports...')
          failed_imports = []

          for package in packages:
              try:
                  __import__(package)
                  print(f'‚úì {package}')
              except ImportError as e:
                  print(f'‚úó {package}: {e}')
                  failed_imports.append(package)

          if failed_imports:
              print(f'\nFailed to import {len(failed_imports)} package(s): {failed_imports}')
              sys.exit(1)
          else:
              print(f'\n‚úì All {len(packages)} packages imported successfully')
          "

      - name: Verify requirements.txt packages
        run: |
          python -c "
          import subprocess
          import sys

          # Read requirements.txt and extract package names
          with open('requirements.txt', 'r') as f:
              lines = f.readlines()

          required_packages = []
          for line in lines:
              line = line.strip()
              if line and not line.startswith('#'):
                  # Extract package name (before ==, >=, etc.)
                  pkg_name = line.split('==')[0].split('>=')[0].split('<=')[0].strip()
                  required_packages.append(pkg_name)

          # Get installed packages
          result = subprocess.run(['pip', 'list', '--format=freeze'],
                                capture_output=True, text=True, check=True)
          installed = {line.split('==')[0].lower() for line in result.stdout.splitlines()}

          print(f'Checking {len(required_packages)} required packages...')
          missing = []
          for pkg in required_packages:
              if pkg.lower() not in installed:
                  print(f'‚úó Missing: {pkg}')
                  missing.append(pkg)
              else:
                  print(f'‚úì Installed: {pkg}')

          if missing:
              print(f'\n‚ùå {len(missing)} package(s) missing from installation')
              sys.exit(1)
          else:
              print(f'\n‚úÖ All {len(required_packages)} required packages are installed')
          "

  pip-audit-scan:
    name: Python Dependency Vulnerability Scan (pip-audit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit>=2.6.0

      - name: Run pip-audit vulnerability scan
        run: |
          echo "============================================"
          echo "Running pip-audit vulnerability scan"
          echo "Scanning against PyPI Advisory Database"
          echo "============================================"
          echo ""

          # Run pip-audit with requirements.txt
          # --desc: Include vulnerability descriptions
          # --format: Use table format for readable output
          # --requirement: Scan from requirements.txt file
          pip-audit --desc --format table --requirement requirements.txt | tee pip-audit-results.txt
        continue-on-error: true
        id: pip_audit_scan

      - name: Run pip-audit (SARIF output for GitHub Security)
        run: |
          echo ""
          echo "============================================"
          echo "Generating SARIF output for GitHub Security"
          echo "============================================"
          echo ""

          # Generate SARIF format for GitHub Security tab integration
          # SARIF (Static Analysis Results Interchange Format) is the standard
          # format for uploading security findings to GitHub
          pip-audit --format sarif --requirement requirements.txt > pip-audit-results.sarif || true
        continue-on-error: true

      - name: Run pip-audit with severity filtering
        run: |
          echo ""
          echo "============================================"
          echo "Checking for HIGH and CRITICAL vulnerabilities"
          echo "============================================"
          echo ""

          # This will fail the job if HIGH or CRITICAL vulnerabilities are found
          # --vulnerability-service: Use PyPI Advisory Database (default)
          # Other options: osv (for OSV database)
          pip-audit --desc --format json --requirement requirements.txt > pip-audit-results.json || true

          # Check if any HIGH or CRITICAL vulnerabilities exist
          python -c "
          import json
          import sys

          try:
              with open('pip-audit-results.json', 'r') as f:
                  results = json.load(f)

              dependencies = results.get('dependencies', [])
              high_or_critical = []

              for dep in dependencies:
                  vulns = dep.get('vulns', [])
                  for vuln in vulns:
                      # pip-audit doesn't provide severity in standard output
                      # but we can check for CVEs
                      vuln_id = vuln.get('id', 'Unknown')
                      description = vuln.get('description', '')
                      high_or_critical.append({
                          'package': dep.get('name'),
                          'version': dep.get('version'),
                          'vuln_id': vuln_id,
                          'description': description[:100] + '...' if len(description) > 100 else description
                      })

              if high_or_critical:
                  print(f'‚ùå Found {len(high_or_critical)} vulnerability/vulnerabilities:')
                  print('')
                  for vuln in high_or_critical:
                      print(f'  Package: {vuln[\"package\"]} {vuln[\"version\"]}')
                      print(f'  Vulnerability: {vuln[\"vuln_id\"]}')
                      print(f'  Description: {vuln[\"description\"]}')
                      print('')
                  print('‚ö†Ô∏è  Please review and address these vulnerabilities.')
                  print('üí° You can update dependencies or add ignored vulnerabilities to pyproject.toml')
                  sys.exit(1)
              else:
                  print('‚úÖ No vulnerabilities found!')
                  print('All dependencies are secure.')
          except FileNotFoundError:
              print('‚ö†Ô∏è  pip-audit results file not found')
              print('Scan may have failed - please review logs above')
              sys.exit(1)
          except json.JSONDecodeError:
              print('‚ö†Ô∏è  Failed to parse pip-audit results')
              sys.exit(1)
          "

      - name: Upload pip-audit SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'pip-audit-results.sarif'
          category: 'pip-audit'
        continue-on-error: true

      - name: Upload pip-audit results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-results
          path: |
            pip-audit-results.txt
            pip-audit-results.json
            pip-audit-results.sarif
          retention-days: 90

  safety-scan:
    name: Python Dependency Vulnerability Scan (Safety)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety>=3.0.0

      - name: Run Safety vulnerability scan
        run: |
          echo "============================================"
          echo "Running Safety vulnerability scan"
          echo "Scanning against Safety DB"
          echo "============================================"
          echo ""

          # Run safety check with requirements.txt
          # Safety 3.x uses 'safety scan' command
          # --output: Output format (text for human readable)
          # Note: Safety free tier has limitations, basic scan is always available
          safety check --file requirements.txt --output text | tee safety-results.txt || true
        continue-on-error: true
        id: safety_scan

      - name: Run Safety with JSON output and validation
        run: |
          echo ""
          echo "============================================"
          echo "Validating Safety scan results"
          echo "============================================"
          echo ""

          # Run safety check with JSON output
          # The --json flag provides structured output for parsing
          safety check --file requirements.txt --json > safety-results.json || true

          # Validate the results
          python -c "
          import json
          import sys
          import os

          try:
              with open('safety-results.json', 'r') as f:
                  content = f.read().strip()

              # Check if file is empty or scan succeeded with no findings
              if not content or content == '[]':
                  print('‚úÖ No vulnerabilities found!')
                  print('All dependencies passed Safety DB checks.')
                  sys.exit(0)

              # Parse results
              results = json.loads(content)

              # Safety JSON format is a list of vulnerabilities
              if isinstance(results, list) and len(results) > 0:
                  print(f'‚ùå Found {len(results)} vulnerability/vulnerabilities:')
                  print('')

                  for vuln in results:
                      # Safety JSON structure includes:
                      # - package: package name
                      # - installed_version: current version
                      # - vulnerability_id: Safety DB ID or CVE
                      # - advisory: description
                      # - severity: severity level (if available)
                      package = vuln.get('package', 'Unknown')
                      version = vuln.get('installed_version', 'Unknown')
                      vuln_id = vuln.get('vulnerability_id', 'Unknown')
                      advisory = vuln.get('advisory', 'No description available')
                      severity = vuln.get('severity', 'Unknown')

                      print(f'  Package: {package} {version}')
                      print(f'  Vulnerability: {vuln_id}')
                      if severity != 'Unknown':
                          print(f'  Severity: {severity}')
                      # Truncate long advisory text
                      if len(advisory) > 150:
                          print(f'  Advisory: {advisory[:150]}...')
                      else:
                          print(f'  Advisory: {advisory}')
                      print('')

                  print('‚ö†Ô∏è  Please review and address these vulnerabilities.')
                  print('üí° Safety DB provides vulnerability data from multiple sources')
                  print('üí° Cross-reference with pip-audit results for comprehensive coverage')
                  sys.exit(1)
              else:
                  print('‚úÖ No vulnerabilities found!')
                  print('All dependencies passed Safety DB checks.')

          except FileNotFoundError:
              print('‚ö†Ô∏è  Safety results file not found')
              print('Scan may have failed - please review logs above')
              sys.exit(1)
          except json.JSONDecodeError as e:
              print(f'‚ö†Ô∏è  Failed to parse Safety results: {e}')
              print('Output may not be in JSON format - check scan logs')
              sys.exit(1)
          except Exception as e:
              print(f'‚ö†Ô∏è  Unexpected error: {e}')
              sys.exit(1)
          "

      - name: Upload Safety results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-results
          path: |
            safety-results.txt
            safety-results.json
          retention-days: 90

  trivy-scan:
    name: Filesystem Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: 'trivy.yaml'
          format: 'table'
          output: 'trivy-results.txt'
        continue-on-error: true
        id: trivy_scan

      - name: Run Trivy vulnerability scanner (SARIF output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: 'trivy.yaml'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
        continue-on-error: false

      - name: Run Trivy vulnerability scanner (JSON output for validation)
        run: |
          trivy fs --config trivy.yaml --format json --output trivy-results.json --timeout 15m . || true
        continue-on-error: true

      - name: Validate Trivy scan results
        run: |
          echo ""
          echo "============================================"
          echo "Validating Trivy scan results"
          echo "============================================"
          echo ""

          # Check if results file exists
          if [ ! -f trivy-results.json ]; then
            echo "‚ö†Ô∏è  Trivy results file not found"
            echo "Scan may have failed - please review logs above"
            exit 1
          fi

          # Parse and validate results
          python -c "
          import json
          import sys
          import os

          try:
              with open('trivy-results.json', 'r') as f:
                  results = json.load(f)

              # Trivy JSON structure: results is a dict with 'Results' key
              # Each result has 'Vulnerabilities' list
              total_vulns = 0
              critical_count = 0
              high_count = 0
              medium_count = 0
              low_count = 0

              vulnerabilities_by_severity = {
                  'CRITICAL': [],
                  'HIGH': [],
                  'MEDIUM': [],
                  'LOW': [],
                  'UNKNOWN': []
              }

              # Process all results
              for result in results.get('Results', []):
                  vulns = result.get('Vulnerabilities', [])
                  if vulns:
                      for vuln in vulns:
                          total_vulns += 1
                          severity = vuln.get('Severity', 'UNKNOWN')

                          vuln_info = {
                              'id': vuln.get('VulnerabilityID', 'Unknown'),
                              'pkg_name': vuln.get('PkgName', 'Unknown'),
                              'installed_version': vuln.get('InstalledVersion', 'Unknown'),
                              'fixed_version': vuln.get('FixedVersion', 'Not available'),
                              'title': vuln.get('Title', 'No title'),
                              'description': vuln.get('Description', 'No description')
                          }

                          if severity in vulnerabilities_by_severity:
                              vulnerabilities_by_severity[severity].append(vuln_info)
                          else:
                              vulnerabilities_by_severity['UNKNOWN'].append(vuln_info)

                          if severity == 'CRITICAL':
                              critical_count += 1
                          elif severity == 'HIGH':
                              high_count += 1
                          elif severity == 'MEDIUM':
                              medium_count += 1
                          elif severity == 'LOW':
                              low_count += 1

              # Report results
              if total_vulns == 0:
                  print('‚úÖ No vulnerabilities found!')
                  print('All dependencies passed Trivy filesystem scan.')
                  sys.exit(0)

              # Print summary
              print(f'‚ùå Found {total_vulns} vulnerability/vulnerabilities:')
              print('')
              print('Severity Breakdown:')
              print(f'  CRITICAL: {critical_count}')
              print(f'  HIGH: {high_count}')
              print(f'  MEDIUM: {medium_count}')
              print(f'  LOW: {low_count}')
              print('')

              # Print CRITICAL and HIGH vulnerabilities in detail
              for severity in ['CRITICAL', 'HIGH']:
                  if vulnerabilities_by_severity[severity]:
                      print(f'{severity} Severity Vulnerabilities:')
                      print('-' * 60)
                      for vuln in vulnerabilities_by_severity[severity]:
                          print(f\"  {vuln['id']}: {vuln['pkg_name']} {vuln['installed_version']}\")
                          print(f\"    Title: {vuln['title'][:80]}...\" if len(vuln['title']) > 80 else f\"    Title: {vuln['title']}\")
                          if vuln['fixed_version'] != 'Not available':
                              print(f\"    Fixed in: {vuln['fixed_version']}\")
                          print('')

              # Print summary for MEDIUM and LOW
              if vulnerabilities_by_severity['MEDIUM']:
                  print(f\"MEDIUM Severity: {len(vulnerabilities_by_severity['MEDIUM'])} vulnerabilities found\")
                  for vuln in vulnerabilities_by_severity['MEDIUM'][:3]:  # Show first 3
                      print(f\"  - {vuln['id']}: {vuln['pkg_name']}\")
                  if len(vulnerabilities_by_severity['MEDIUM']) > 3:
                      print(f\"  ... and {len(vulnerabilities_by_severity['MEDIUM']) - 3} more\")
                  print('')

              if vulnerabilities_by_severity['LOW']:
                  print(f\"LOW Severity: {len(vulnerabilities_by_severity['LOW'])} vulnerabilities found\")
                  print('')

              print('‚ö†Ô∏è  Please review and address these vulnerabilities.')
              print('üí° Trivy scans multiple vulnerability databases (NVD, GitHub, etc.)')
              print('üí° Cross-reference with pip-audit and Safety results for comprehensive coverage')
              print('üí° Review SARIF output in GitHub Security tab for detailed information')
              sys.exit(1)

          except FileNotFoundError:
              print('‚ö†Ô∏è  Trivy results file not found')
              print('Scan may have failed - please review logs above')
              sys.exit(1)
          except json.JSONDecodeError as e:
              print(f'‚ö†Ô∏è  Failed to parse Trivy results: {e}')
              print('Output may not be in valid JSON format - check scan logs')
              sys.exit(1)
          except Exception as e:
              print(f'‚ö†Ô∏è  Unexpected error: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'
        continue-on-error: true

      - name: Upload Trivy results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results
          path: |
            trivy-results.txt
            trivy-results.sarif
            trivy-results.json
          retention-days: 90
