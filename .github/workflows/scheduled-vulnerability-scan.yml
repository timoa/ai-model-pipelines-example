name: Scheduled Vulnerability Scan

on:
  # Run daily at 2 AM UTC to catch newly disclosed vulnerabilities
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

  # Allow manual triggering for testing
  workflow_dispatch:

# Prevent multiple scheduled scans from running concurrently
concurrency:
  group: scheduled-vuln-scan
  cancel-in-progress: false

jobs:
  scheduled-pip-audit:
    name: Scheduled Python Dependency Scan (pip-audit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write  # For creating issues on vulnerabilities

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Always scan main branch

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit>=2.6.0

      - name: Run pip-audit vulnerability scan
        run: |
          echo "============================================"
          echo "Scheduled pip-audit vulnerability scan"
          echo "Scanning main branch dependencies"
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "============================================"
          echo ""

          pip-audit --desc --format table --requirement requirements.txt | tee pip-audit-results.txt
        continue-on-error: true
        id: pip_audit_scan

      - name: Generate SARIF output
        run: |
          pip-audit --format sarif --requirement requirements.txt > pip-audit-results.sarif || true
        continue-on-error: true

      - name: Generate JSON output
        run: |
          pip-audit --desc --format json --requirement requirements.txt > pip-audit-results.json || true
        continue-on-error: true

      - name: Check for vulnerabilities
        id: check_vulns
        run: |
          python -c "
          import json
          import sys
          import os

          try:
              with open('pip-audit-results.json', 'r') as f:
                  results = json.load(f)

              dependencies = results.get('dependencies', [])
              vulnerabilities = []

              for dep in dependencies:
                  vulns = dep.get('vulns', [])
                  for vuln in vulns:
                      vulnerabilities.append({
                          'package': dep.get('name'),
                          'version': dep.get('version'),
                          'vuln_id': vuln.get('id', 'Unknown'),
                          'description': vuln.get('description', '')
                      })

              # Set output for GitHub Actions
              if vulnerabilities:
                  print(f'found={len(vulnerabilities)}')
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f'vulnerabilities_found=true\n')
                      f.write(f'vuln_count={len(vulnerabilities)}\n')

                  print(f'\nâš ï¸  Found {len(vulnerabilities)} vulnerability/vulnerabilities')
                  for vuln in vulnerabilities[:5]:  # Show first 5
                      print(f\"  - {vuln['package']} {vuln['version']}: {vuln['vuln_id']}\")
                  if len(vulnerabilities) > 5:
                      print(f'  ... and {len(vulnerabilities) - 5} more')
              else:
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('vulnerabilities_found=false\n')
                      f.write('vuln_count=0\n')
                  print('âœ… No vulnerabilities found')

          except Exception as e:
              print(f'Error checking vulnerabilities: {e}')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('vulnerabilities_found=error\n')
          "
        continue-on-error: true

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'pip-audit-results.sarif'
          category: 'scheduled-pip-audit'
        continue-on-error: true

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scheduled-pip-audit-results-${{ github.run_number }}
          path: |
            pip-audit-results.txt
            pip-audit-results.json
            pip-audit-results.sarif
          retention-days: 90

      - name: Create issue on vulnerabilities found
        if: steps.check_vulns.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the scan results
            let resultsText = 'Could not read results';
            try {
              resultsText = fs.readFileSync('pip-audit-results.txt', 'utf8');
            } catch (e) {
              console.log('Error reading results file:', e);
            }

            const vulnCount = '${{ steps.check_vulns.outputs.vuln_count }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,vulnerability,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Scheduled Vulnerability Scan')
            );

            const issueBody = `## ðŸ”’ Scheduled Vulnerability Scan Alert

            **Date:** ${new Date().toISOString().split('T')[0]}
            **Scan Type:** pip-audit (PyPI Advisory Database)
            **Vulnerabilities Found:** ${vulnCount}

            ### Summary

            The scheduled vulnerability scan has detected ${vulnCount} vulnerability/vulnerabilities in the project dependencies.

            ### Scan Results

            \`\`\`
            ${resultsText.slice(0, 5000)}${resultsText.length > 5000 ? '\n... (truncated, see artifacts for full results)' : ''}
            \`\`\`

            ### Actions Required

            1. Review the vulnerabilities listed above
            2. Update affected dependencies to patched versions
            3. If updates are not possible, document justification in \`pyproject.toml\`
            4. Review cross-scanner results (Safety, Trivy) for comprehensive coverage

            ### Resources

            - [Full scan results (artifacts)](${runUrl})
            - [GitHub Security tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security)
            - [Security scanning documentation](docs/SECURITY_SCANNING.md)

            ---
            *This issue was automatically created by the scheduled vulnerability scan workflow.*
            *Scan run: [#${context.runNumber}](${runUrl})*
            `;

            if (existingIssue) {
              // Update existing issue with new information
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### ðŸ”„ Updated Scan Results\n\n${issueBody}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Scheduled Vulnerability Scan - ${vulnCount} vulnerabilities found`,
                body: issueBody,
                labels: ['security', 'vulnerability', 'automated']
              });
              console.log('Created new security issue');
            }
        continue-on-error: true

  scheduled-safety:
    name: Scheduled Python Dependency Scan (Safety)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety>=3.0.0

      - name: Run Safety vulnerability scan
        run: |
          echo "============================================"
          echo "Scheduled Safety vulnerability scan"
          echo "Scanning main branch dependencies"
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "============================================"
          echo ""

          safety check --file requirements.txt --output text | tee safety-results.txt || true
        continue-on-error: true

      - name: Generate JSON output
        run: |
          safety check --file requirements.txt --json > safety-results.json || true
        continue-on-error: true

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scheduled-safety-results-${{ github.run_number }}
          path: |
            safety-results.txt
            safety-results.json
          retention-days: 90

  scheduled-trivy:
    name: Scheduled Filesystem Scan (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: 'trivy.yaml'
          format: 'table'
          output: 'trivy-results.txt'
        continue-on-error: true

      - name: Generate SARIF output
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: 'trivy.yaml'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Generate JSON output
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: 'trivy.yaml'
          format: 'json'
          output: 'trivy-results.json'
        continue-on-error: true

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'scheduled-trivy'
        continue-on-error: true

      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scheduled-trivy-results-${{ github.run_number }}
          path: |
            trivy-results.txt
            trivy-results.sarif
            trivy-results.json
          retention-days: 90

  summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    needs: [scheduled-pip-audit, scheduled-safety, scheduled-trivy]
    if: always()

    steps:
      - name: Generate scan summary
        run: |
          echo "============================================"
          echo "Scheduled Vulnerability Scan Summary"
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "============================================"
          echo ""
          echo "âœ… Scheduled vulnerability scan completed"
          echo ""
          echo "Scans performed:"
          echo "  - pip-audit (PyPI Advisory Database)"
          echo "  - Safety (Safety DB)"
          echo "  - Trivy (Multiple databases)"
          echo ""
          echo "Results have been:"
          echo "  - Uploaded to GitHub Security tab (SARIF format)"
          echo "  - Saved as workflow artifacts (90-day retention)"
          echo "  - Used to create/update security issues (if vulnerabilities found)"
          echo ""
          echo "Review the Security tab and workflow artifacts for detailed results."
          echo "This scan does not block development - it provides visibility only."
